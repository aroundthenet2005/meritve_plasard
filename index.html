<!doctype html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plasard</title>
<style>
  :root {
    --bg: #0e0f12;
    --square: #000000;
    --grid: 32px;
    --card-bg: rgba(238, 244, 255, 0.96);
    --card-border: rgba(255, 255, 255, 0.85);
    --card-glow: rgba(110, 186, 255, 0.45);
    --text: #e9eef2;
    --muted: #97a2ad;
  }

  * { box-sizing: border-box; }
  html, body { width: 100%; height: 100%; margin: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: "Bahnschrift", "Trebuchet MS", "Segoe UI", sans-serif;
    overflow: hidden;
  }

  #viewport {
    position: fixed;
    inset: 0;
    background-color: var(--bg);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Crect width='4' height='4' fill='%23000'/%3E%3C/svg%3E");
    background-size: var(--grid) var(--grid);
    background-position: 0 0;
    cursor: grab;
  }
  #viewport.dragging { cursor: grabbing; }

  .vignette {
    position: fixed;
    inset: 0;
    pointer-events: none;
    background:
      radial-gradient(1200px 800px at 50% 50%, rgba(255,255,255,0.06), rgba(0,0,0,0.72) 70%),
      linear-gradient(180deg, rgba(10,12,16,0.3), rgba(5,6,8,0.8));
  }

  .app-group {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .app-card {
    min-width: 260px;
    padding: 18px 20px;
    border-radius: 16px;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: #0f1620;
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.04) inset,
      0 18px 40px rgba(0,0,0,0.45),
      0 0 24px var(--card-glow);
    transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
  }

  .app-card.alt {
    background: rgba(244, 250, 244, 0.96);
    border-color: rgba(255, 255, 255, 0.85);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.04) inset,
      0 18px 40px rgba(0,0,0,0.45),
      0 0 24px rgba(120, 220, 160, 0.45);
  }

  .app-card a {
    display: block;
    color: inherit;
    text-decoration: none;
  }

  .app-title {
    font-size: 18px;
    letter-spacing: 0.4px;
    font-weight: 700;
    margin: 0 0 6px 0;
  }

  .app-sub {
    margin: 0;
    font-size: 12px;
    color: #4b5a6b;
  }

  .app-card:hover {
    border-color: rgba(64, 188, 255, 0.45);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.06) inset,
      0 18px 40px rgba(0,0,0,0.45),
      0 0 30px rgba(64, 188, 255, 0.4);
  }

  .hint {
    position: fixed;
    left: 16px;
    bottom: 16px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(10, 12, 16, 0.7);
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.2px;
    backdrop-filter: blur(8px);
  }

  .hidden { display: none !important; }

  .login-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(6, 8, 10, 0.82);
    z-index: 20;
    padding: 16px;
  }

  .login-card {
    width: 100%;
    max-width: 360px;
    background: rgba(238, 244, 255, 0.97);
    border: 1px solid rgba(255, 255, 255, 0.9);
    border-radius: 16px;
    padding: 16px;
    color: #0f1620;
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.04) inset,
      0 18px 40px rgba(0,0,0,0.45);
  }

  .login-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .login-sub {
    font-size: 12px;
    color: #4b5a6b;
    margin-bottom: 10px;
  }

  .login-card label {
    display: block;
    font-size: 12px;
    color: #4b5a6b;
    margin: 10px 0 6px;
  }

  .login-card input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid rgba(12, 16, 22, 0.2);
    background: #ffffff;
    color: #0f1620;
    font-family: inherit;
    outline: none;
  }

  .login-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-top: 10px;
    font-size: 12px;
    color: #4b5a6b;
  }

  .login-err {
    color: #b01c1c;
    font-size: 12px;
    margin-top: 8px;
  }

  .login-btn {
    border: 1px solid rgba(12, 16, 22, 0.15);
    background: #0f1620;
    color: #ffffff;
    padding: 8px 12px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 12px;
    letter-spacing: 0.2px;
  }

  .user-pill {
    position: fixed;
    top: 16px;
    right: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(10, 12, 16, 0.7);
    font-size: 12px;
    color: var(--text);
    z-index: 6;
    backdrop-filter: blur(8px);
  }

  .user-pill button {
    border: 1px solid rgba(255,255,255,0.2);
    background: transparent;
    color: var(--text);
    padding: 4px 8px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 12px;
  }

  .focus-ring:focus-visible {
    outline: 2px solid rgba(64, 188, 255, 0.9);
    outline-offset: 4px;
  }
</style>
</head>
<body>
  <div id="login_overlay" class="login-overlay">
    <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="login_title">
      <div id="login_title" class="login-title">Prijava</div>
      <div class="login-sub">Za vstop v Plasard</div>
      <label>Uporabniško ime</label>
      <input id="login_user" autocomplete="username" />
      <label>Geslo</label>
      <input id="login_pass" type="password" autocomplete="current-password" />
      <div id="login_err" class="login-err hidden"></div>
      <div class="login-row">
        <div id="login_status"></div>
        <button class="login-btn" id="login_btn" type="button">Vstop</button>
      </div>
    </div>
  </div>
  <div id="user_badge" class="user-pill hidden">
    <span id="user_name"></span>
    <button id="logout_btn" type="button">Odjava</button>
  </div>
  <div id="viewport" aria-label="Površina za premikanje">
    <div id="app_group" class="app-group">
      <div class="app-card" data-app="measure">
        <a class="focus-ring" href="Plasard_Merilec_Offline/index.html">
          <h1 class="app-title">Plasard Meritve</h1>
          <p class="app-sub">Odpri aplikacijo</p>
        </a>
      </div>
      <div class="app-card alt" data-app="knowledge">
        <a class="focus-ring" href="VSO_ZNANJE/index.html">
          <h1 class="app-title">Vso Znanje</h1>
          <p class="app-sub">Odpri chatbot</p>
        </a>
      </div>
    </div>
  </div>
  <div class="vignette" aria-hidden="true"></div>
  <div class="hint">Povleci z miško za premik</div>

<script type="text/plain" id="users_fallback">
Ime in priimek: Domen Hohnjec
Uporabniško ime: aroundthenet9
Geslo: 81217

Ime in priimek: Sebastian Hohnjec
Uporabniško ime: sebastianh
Geslo: 0107

Ime in priimek: Damjana Hohnjec
Uporabniško ime: damjanah
Geslo: 0277

Ime in priimek: Slavko Golob
Uporabniško ime: slavkog
Geslo: 2280

Ime in priimek: Tim Polavder
Uporabniško ime: timp
Geslo: 2102

Ime in priimek: Jernej Skerbis
Uporabniško ime: Jersnejs
Geslo: 1298
</script>

<script>
(() => {
  const LS_LOGIN = "plasard_login_v1";
  const WINDOW_SESSION_KEY = "plasard_session_v1";
  const ADMIN_FULL_NAME = "Domen Hohnjec";
  const ADMIN_USERNAME = "aroundthenet9";
  const FULL_ACCESS_NAMES = ["Domen Hohnjec", "Sebastian Hohnjec"];
  const FULL_ACCESS_USERS = ["aroundthenet9", "sebastianh"];

  const overlay = document.getElementById("login_overlay");
  const userEl = document.getElementById("login_user");
  const passEl = document.getElementById("login_pass");
  const errEl = document.getElementById("login_err");
  const statusEl = document.getElementById("login_status");
  const loginBtn = document.getElementById("login_btn");
  const badge = document.getElementById("user_badge");
  const badgeName = document.getElementById("user_name");
  const logoutBtn = document.getElementById("logout_btn");
  const knowledgeCard = document.querySelector('[data-app="knowledge"]');
  const measureLink = document.querySelector('[data-app="measure"] a');
  const knowledgeLink = document.querySelector('[data-app="knowledge"] a');
  const defaultMeasureHref = measureLink ? measureLink.getAttribute("href") : "";
  const defaultKnowledgeHref = knowledgeLink ? knowledgeLink.getAttribute("href") : "";

  let currentUser = null;
  let currentSession = null;
  let users = [];

  const normalizeName = (name) => String(name || "").trim().toLowerCase();
  const isAdminUser = (u) => {
    if (!u) return false;
    const nameOk = normalizeName(u.fullName) === normalizeName(ADMIN_FULL_NAME);
    const userOk = normalizeName(u.username) === normalizeName(ADMIN_USERNAME);
    return nameOk || userOk;
  };
  const isFullAccessUser = (u) => {
    if (!u) return false;
    const nameOk = FULL_ACCESS_NAMES.some(n => normalizeName(n) === normalizeName(u.fullName));
    const userOk = FULL_ACCESS_USERS.some(n => normalizeName(n) === normalizeName(u.username));
    return nameOk || userOk;
  };

  function todayKey() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function saveLoginSession(user) {
    if (!user) return;
    const session = {
      username: user.username || "",
      fullName: user.fullName || "",
      date: todayKey(),
      ts: Date.now()
    };
    currentSession = session;
    localStorage.setItem(LS_LOGIN, JSON.stringify(session));
    try { window.name = JSON.stringify({ key: WINDOW_SESSION_KEY, session }); } catch (e) {}
  }

  function loadLoginSession() {
    try {
      const raw = localStorage.getItem(LS_LOGIN);
      return raw ? JSON.parse(raw) : null;
    } catch (e) {
      return null;
    }
  }

  function clearLoginSession() {
    localStorage.removeItem(LS_LOGIN);
    currentSession = null;
    try {
      const payload = JSON.parse(window.name || "");
      if (payload && payload.key === WINDOW_SESSION_KEY) window.name = "";
    } catch (e) {}
  }

  function readWindowNameSession() {
    const raw = (window.name || "").trim();
    if (!raw) return null;
    try {
      const payload = JSON.parse(raw);
      if (payload && payload.key === WINDOW_SESSION_KEY && payload.session) return payload.session;
    } catch (e) {}
    return null;
  }

  function getSessionUser(session, usersList) {
    if (!session || !session.username) return null;
    return usersList.find(u => u.username === session.username) || null;
  }

  function encodeSession(session) {
    if (!session) return "";
    try {
      return btoa(encodeURIComponent(JSON.stringify(session)));
    } catch (e) {
      return "";
    }
  }

  function setLinkWithSession(link, baseHref, session) {
    if (!link || !baseHref) return;
    if (!session) {
      link.setAttribute("href", baseHref);
      return;
    }
    const token = encodeSession(session);
    link.setAttribute("href", token ? `${baseHref}#s=${encodeURIComponent(token)}` : baseHref);
  }

  function updateAppLinks() {
    setLinkWithSession(measureLink, defaultMeasureHref, currentSession);
    setLinkWithSession(knowledgeLink, defaultKnowledgeHref, currentSession);
  }

  async function loadUsersText() {
    let txt = "";
    if (statusEl) statusEl.textContent = "Nalaganje uporabnikov...";
    try {
      const res = await fetch("Plasard_Merilec_Offline/users.txt", { cache: "no-store" });
      if (res.ok) txt = await res.text();
    } catch (e) {}
    if (!txt) {
      const fallback = document.getElementById("users_fallback");
      if (fallback) txt = fallback.textContent || "";
    }
    if (statusEl) statusEl.textContent = txt ? "" : "Ni uporabnikov v users.txt.";
    return txt;
  }

  function parseUsers(raw) {
    const list = [];
    let current = { fullName: "", username: "", password: "" };
    const flush = () => {
      if (current.username && current.password) list.push({ ...current });
      current = { fullName: "", username: "", password: "" };
    };
    const cleaned = String(raw || "").replace(/^\uFEFF/, "");
    const lines = cleaned.split(/\r?\n/);
    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed) continue;
      if (trimmed.startsWith("#")) continue;
      let m;
      if ((m = trimmed.match(/^Ime in priimek\s*:\s*(.*)$/i))) {
        if (current.username || current.password || current.fullName) flush();
        current.fullName = (m[1] || "").trim();
        continue;
      }
      if ((m = trimmed.match(/^Uporabni[šs]ko ime\s*:\s*(.*)$/i))) {
        current.username = (m[1] || "").trim();
        continue;
      }
      if ((m = trimmed.match(/^Geslo\s*:\s*(.*)$/i))) {
        current.password = (m[1] || "").trim();
        continue;
      }
    }
    flush();
    return list;
  }

  async function reloadUsers() {
    const raw = await loadUsersText();
    users = parseUsers(raw);
    return users;
  }

  function setError(msg) {
    if (!errEl) return;
    errEl.textContent = msg || "";
    errEl.classList.toggle("hidden", !msg);
  }

  function applyAccess() {
    if (knowledgeCard) {
      knowledgeCard.classList.toggle("hidden", !isFullAccessUser(currentUser));
    }
    if (badge && badgeName) {
      if (!currentUser) {
        badge.classList.add("hidden");
      } else {
        const role = isAdminUser(currentUser)
          ? "admin"
          : (isFullAccessUser(currentUser) ? "vse" : "meritve");
        badgeName.textContent = `${currentUser.fullName || currentUser.username} • ${role}`;
        badge.classList.remove("hidden");
      }
    }
    updateAppLinks();
  }

  async function attemptLogin() {
    await reloadUsers();
    const username = (userEl && userEl.value || "").trim();
    const password = passEl ? passEl.value : "";
    if (!users.length) {
      setError("V users.txt ni vnosov.");
      return;
    }
    const match = users.find(u => u.username === username && u.password === password);
    if (match) {
      currentUser = match;
      saveLoginSession(match);
      if (overlay) overlay.classList.add("hidden");
      setError("");
      if (statusEl) statusEl.textContent = "";
      if (userEl) userEl.value = "";
      if (passEl) passEl.value = "";
      applyAccess();
    } else {
      setError("Napačno uporabniško ime ali geslo.");
    }
  }

  async function initLogin() {
    await reloadUsers();
    const stored = loadLoginSession();
    let sessionUser = stored ? getSessionUser(stored, users) : null;
    if (!sessionUser) {
      const winSession = readWindowNameSession();
      if (winSession) {
        sessionUser = getSessionUser(winSession, users);
        if (sessionUser) saveLoginSession(sessionUser);
      }
    }
    if (sessionUser) {
      currentUser = sessionUser;
      currentSession = sessionUser;
      saveLoginSession(sessionUser);
      if (overlay) overlay.classList.add("hidden");
      setError("");
      applyAccess();
    } else {
      if (stored) clearLoginSession();
      if (overlay) overlay.classList.remove("hidden");
      applyAccess();
    }
  }

  if (loginBtn) {
    loginBtn.addEventListener("click", attemptLogin);
  }
  [userEl, passEl].forEach((el) => {
    if (!el) return;
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        attemptLogin();
      }
    });
  });
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      currentUser = null;
      clearLoginSession();
      applyAccess();
      if (overlay) overlay.classList.remove("hidden");
    });
  }

  initLogin();

  const viewport = document.getElementById('viewport');
  const group = document.getElementById('app_group');

  let offsetX = 0;
  let offsetY = 0;
  let dragging = false;
  let lastX = 0;
  let lastY = 0;

  const updatePosition = () => {
    group.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px)`;
    viewport.style.backgroundPosition = `${offsetX}px ${offsetY}px`;
  };

  const beginDrag = (event) => {
    if (event.target.closest('a')) return;
    dragging = true;
    viewport.classList.add('dragging');
    lastX = event.clientX;
    lastY = event.clientY;
    viewport.setPointerCapture(event.pointerId);
  };

  const moveDrag = (event) => {
    if (!dragging) return;
    const dx = event.clientX - lastX;
    const dy = event.clientY - lastY;
    offsetX += dx;
    offsetY += dy;
    lastX = event.clientX;
    lastY = event.clientY;
    updatePosition();
  };

  const endDrag = (event) => {
    if (!dragging) return;
    dragging = false;
    viewport.classList.remove('dragging');
    if (event.pointerId !== undefined) {
      viewport.releasePointerCapture(event.pointerId);
    }
  };

  viewport.addEventListener('pointerdown', beginDrag);
  viewport.addEventListener('pointermove', moveDrag);
  window.addEventListener('pointerup', endDrag);
  window.addEventListener('pointercancel', endDrag);

  viewport.addEventListener('wheel', (event) => {
    event.preventDefault();
    offsetX -= event.deltaX;
    offsetY -= event.deltaY;
    updatePosition();
  }, { passive: false });

  updatePosition();
})();
</script>
</body>
</html>
